import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Link } from 'react-router-dom';
import { ArrowRight, Play } from 'lucide-react';
import TerminalWindow from '@/components/TerminalWindow';
import CodeBlock from '@/components/CodeBlock';
import ProgressBar from '@/components/ProgressBar';
import ModuleSidebar from '@/components/ModuleSidebar';
import ModuleNavigator from '@/components/ModuleNavigator';
import ExploitAnimation from '@/components/ExploitAnimation';
import { useModule } from '@/context/ModuleContext';
import { SECURITY_MODULES } from '@/data/modules';

const ExploitPage = () => {
  const { activeModule } = useModule();
  const module = SECURITY_MODULES[activeModule];
  
  const [currentStep, setCurrentStep] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [showAnimation, setShowAnimation] = useState(false);

  useEffect(() => {
    if (isRunning && currentStep < module.exploitSteps.length) {
      const timer = setTimeout(() => {
        setCurrentStep(prev => prev + 1);
      }, 2000);
      return () => clearTimeout(timer);
    } else if (currentStep >= module.exploitSteps.length && isRunning) {
      setIsRunning(false);
      setShowAnimation(true);
      setTimeout(() => setShowAnimation(false), 2000);
    }
  }, [isRunning, currentStep, module.exploitSteps.length]);

  const startExploit = () => {
    setCurrentStep(0);
    setIsRunning(true);
  };

  const resetExploit = () => {
    setCurrentStep(0);
    setIsRunning(false);
  };

  // Reset when module changes
  useEffect(() => {
    resetExploit();
  }, [activeModule]);

  const progress = (currentStep / module.exploitSteps.length) * 100;

  return (
    <div className="min-h-screen pt-24 pb-16">
      <ExploitAnimation isSuccess={true} isActive={showAnimation} />
      
      <div className="flex">
        <ModuleSidebar />
        
        <div className="flex-1 container mx-auto px-4 max-w-5xl">
          <motion.div 
            key={activeModule}
            initial={{ opacity: 0, y: 20 }} 
            animate={{ opacity: 1, y: 0 }} 
            className="mb-8"
          >
            <div className="flex items-center gap-3 mb-2">
              <span className="text-3xl">{module.icon}</span>
              <h1 className="font-display text-3xl font-bold danger-glow">
                The Exploit: {module.scenario.name}
              </h1>
            </div>
            <p className="text-muted-foreground">Watch how the attack unfolds step by step.</p>
          </motion.div>

          {/* Controls */}
          <div className="flex gap-4 mb-6">
            <button
              onClick={startExploit}
              disabled={isRunning}
              className="flex items-center gap-2 px-6 py-3 bg-destructive text-destructive-foreground rounded-lg font-mono disabled:opacity-50 hover:bg-destructive/90 transition-colors"
            >
              <Play className="w-4 h-4" />
              {isRunning ? 'Exploiting...' : 'Start Exploit Simulation'}
            </button>
            {currentStep > 0 && !isRunning && (
              <button
                onClick={resetExploit}
                className="px-6 py-3 bg-muted rounded-lg font-mono hover:bg-muted/80 transition-colors"
              >
                Reset
              </button>
            )}
          </div>

          {/* Progress */}
          {(isRunning || currentStep > 0) && (
            <div className="mb-6">
              <ProgressBar 
                progress={progress} 
                label={`EXPLOITATION: ${Math.round(progress)}%`}
                variant="danger"
              />
            </div>
          )}

          {/* Exploit Steps */}
          <div className="space-y-4 mb-8">
            {module.exploitSteps.map((step, i) => (
              <motion.div
                key={step.step}
                initial={{ opacity: 0, x: -20 }}
                animate={{ 
                  opacity: currentStep > i ? 1 : 0.3,
                  x: 0,
                  scale: currentStep === i + 1 && isRunning ? 1.02 : 1,
                }}
                transition={{ duration: 0.3 }}
              >
                <TerminalWindow 
                  title={`step_${step.step}.sh`} 
                  variant={currentStep > i ? 'danger' : 'default'}
                >
                  <div className="flex items-start gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                      currentStep > i ? 'bg-destructive text-destructive-foreground' : 'bg-muted'
                    }`}>
                      {step.step}
                    </div>
                    <div className="flex-1">
                      <h3 className={`font-bold text-lg mb-2 ${currentStep > i ? 'text-destructive' : ''}`}>
                        {step.title}
                      </h3>
                      <p className="text-muted-foreground mb-3">{step.description}</p>
                      <CodeBlock code={step.code} language="typescript" />
                    </div>
                  </div>
                </TerminalWindow>
              </motion.div>
            ))}
          </div>

          {/* Success Message */}
          {currentStep >= module.exploitSteps.length && !isRunning && (
            <motion.div
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              className="p-6 danger-border rounded-lg bg-destructive/10 text-center mb-8"
            >
              <motion.h2 
                className="font-display text-2xl font-bold mb-2 text-destructive"
                animate={{
                  textShadow: [
                    '0 0 10px hsl(var(--destructive))',
                    '0 0 20px hsl(var(--destructive))',
                    '0 0 10px hsl(var(--destructive))',
                  ],
                }}
                transition={{ duration: 0.5, repeat: Infinity }}
              >
                ðŸ’€ EXPLOIT SUCCESSFUL ðŸ’€
              </motion.h2>
              <p className="text-destructive/80">
                The vulnerable contract was exploited! Now let's learn how to fix it.
              </p>
            </motion.div>
          )}

          <ModuleNavigator />

          <div className="flex justify-end mt-6">
            <Link 
              to="/fix" 
              className="inline-flex items-center gap-2 px-6 py-3 bg-success text-success-foreground rounded-lg font-mono hover:bg-success/90 transition-colors"
            >
              Learn the Fix <ArrowRight className="w-4 h-4" />
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ExploitPage;
